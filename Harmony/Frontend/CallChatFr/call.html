<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>–ó–≤–æ–Ω–æ–∫</title>
    <link rel="stylesheet" href="../styles.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.0/signalr.min.js"></script>
</head>
<body>
<div class="container">
    <h1 id="callChatTitle"></h1>
    <div id="videoContainer">
        <div class="video-wrapper">
            <video id="localVideo" autoplay muted playsinline></video>
            <div class="camera-placeholder" id="localCameraPlaceholder">–ö–∞–º–µ—Ä–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞</div>
            <div class="nickname-label" id="localNickname"></div>
        </div>
    </div>
<div class="nav-buttons">
  <button id="micButton" onclick="toggleMic()">–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª—é—á–µ–Ω</button>
  <button id="cameraButton" onclick="toggleCamera()">–ö–∞–º–µ—Ä–∞ –≤–∫–ª—é—á–µ–Ω–∞</button>
  <button onclick="toggleScreenShare()">–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞</button>
  <button id="noiseButton" onclick="toggleNoiseSuppression()">–®—É–º–æ–ø–æ–¥–∞–≤–ª–µ–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ</button>
  <button onclick="endCall()">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
</div>
</div>

<script>
const token = localStorage.getItem('token');
const urlParams = new URLSearchParams(window.location.search);
const callChatId = urlParams.get('callChatId');
const channelId = urlParams.get('channelId');
let noiseSuppressionEnabled = true;


if (!token) {
    alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
    window.location.href = '../UserFr/login_user.html';
}

document.getElementById('callChatTitle').textContent = callChatId;

let localStream = null;
let screenStream = null;
let isMicOn = false;
let isCameraOn = false;
let isScreenSharing = false;
let ownConnectionId = null;

const peers = new Map();
const participants = new Map();
const cameraStates = new Map();
const screenSharingStates = new Map();
const pendingCameraStates = new Map();
const pendingScreenSharingStates = new Map();

function getNickName() {
    return localStorage.getItem('nickName') || "–í—ã";
}



const connection = new signalR.HubConnectionBuilder()
    .withUrl(`https://100.123.244.108:5091/hubs/callChat?callChatId=${callChatId}&token=${token}`)
    .withAutomaticReconnect()
    .build();

connection.on("ReceiveSignal", async (message) => {
    const signal = JSON.parse(message);
    const senderId = signal.senderId;

    if (signal.requestNickname) {
    sendSignal(senderId, {
        nickName: getNickName(),
        senderId: ownConnectionId
    });
    return;
}

    // –ù–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–∏–≥–Ω–∞–ª, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Å–∞–º–∏–º —Å–µ–±–µ (–∫—Ä–æ–º–µ joined)
    if (senderId === ownConnectionId && !signal.joined) return;

    if (signal.left) {
        removeParticipant(senderId);
        return;
    }

    if (signal.nickName) {
        const videoWrapper = document.querySelector(`.video-wrapper[data-peer-id="${signal.senderId}"]`);
        if (videoWrapper) {
            let nicknameLabel = videoWrapper.querySelector('.nickname-label');
            if (!nicknameLabel) {
                nicknameLabel = document.createElement('div');
                nicknameLabel.className = 'nickname-label';
                videoWrapper.appendChild(nicknameLabel);
            }
            nicknameLabel.textContent = signal.nickName;
        }
        // –ù–µ –¥–µ–ª–∞–µ–º return, —á—Ç–æ–±—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª–∏—Å—å –¥—Ä—É–≥–∏–µ —Å–∏–≥–Ω–∞–ª—ã
    }

    if (signal.cameraState !== undefined) {
        cameraStates.set(senderId, signal.cameraState);
        const videoElement = participants.get(senderId);
        if (!videoElement) {
            pendingCameraStates.set(senderId, signal.cameraState);
            return;
        }
        updateCameraPlaceholder(senderId);
        return;
    }

    if (signal.screenSharing !== undefined) {
        screenSharingStates.set(senderId, signal.screenSharing);
        const videoElement = participants.get(senderId);
        if (!videoElement) {
            pendingScreenSharingStates.set(senderId, signal.screenSharing);
            return;
        }
        updateCameraPlaceholder(senderId);
        return;
    }

    if (signal.candidate) {
        if (!peers.has(senderId)) await createPeerConnection(senderId);
        const peer = peers.get(senderId);
        if (peer.pc.remoteDescription?.type) {
            try {
                await peer.pc.addIceCandidate(new RTCIceCandidate(signal.candidate));
            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è ICE:", err);
            }
        } else {
            peer.iceQueue.push(signal.candidate);
        }
        return;
    }

    if (signal.offer) {
        if (!peers.has(senderId)) await createPeerConnection(senderId);
        const peer = peers.get(senderId);
        await peer.pc.setRemoteDescription(new RTCSessionDescription(signal.offer));
        await drainIceQueue(peer);
        const answer = await peer.pc.createAnswer();
        await peer.pc.setLocalDescription(answer);
        sendSignal(senderId, { answer });
        return;
    }

    if (signal.answer) {
        const peer = peers.get(senderId);
        if (peer?.pc.signalingState === 'have-local-offer' || peer.pc.signalingState === 'stable') {
            await peer.pc.setRemoteDescription(new RTCSessionDescription(signal.answer));
            await drainIceQueue(peer);
        }
        return;
    }

    if (signal.joined) {
        if (!peers.has(senderId)) {
            await createPeerConnection(senderId);
            const pc = peers.get(senderId).pc;
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            sendSignal(senderId, { offer });

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
            sendSignal(senderId, {
                cameraState: isCameraOn,
                screenSharing: isScreenSharing,
                senderId: ownConnectionId
            });
        }
    }
});

connection.on("UserJoined", async (connectionId) => {
    if (connectionId !== ownConnectionId && !peers.has(connectionId)) {
        await createPeerConnection(connectionId);
        sendSignal(connectionId, {
            nickName: getNickName(), // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–≤–æ–π –Ω–∏–∫–Ω–µ–π–º
            senderId: ownConnectionId
        });
    }
});




connection.on("UserLeft", (connectionId) => {
    removeParticipant(connectionId);
});

async function start() {
    await connection.start();
    ownConnectionId = connection.connectionId;
    await initializeCamera();
    
    // –ü–æ–ª—É—á–∞–µ–º –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –Ω–∏–∫–Ω–µ–π–º
    document.getElementById('localNickname').textContent = getNickName();

    await connection.invoke("SendSignal", JSON.stringify({
        joined: true,
        senderId: ownConnectionId,
        nickName: getNickName() // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É –Ω–∏–∫–Ω–µ–π–º–∞
    }));

    for (const participantId of peers.keys()) {
        sendSignal(participantId, {
            requestNickname: true,
            senderId: ownConnectionId
        });
    }
}

async function initializeCamera() {
    try {
        localStream = await navigator.mediaDevices.getUserMedia({
            video: true,
            audio: {
                noiseSuppression: noiseSuppressionEnabled,
                echoCancellation: true,
                autoGainControl: true
            }
        });

        // –û—Ç–∫–ª—é—á–∞–µ–º —Å—Ä–∞–∑—É
        localStream.getAudioTracks().forEach(track => track.enabled = false);
        localStream.getVideoTracks().forEach(track => track.enabled = false);

        const video = document.getElementById('localVideo');
        video.srcObject = localStream;

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä –∫–∞–º–µ—Ä—ã, —Å–∫—Ä—ã–≤–∞–µ–º –≤–∏–¥–µ–æ
        document.getElementById('localCameraPlaceholder').style.display = 'flex';
        video.style.display = 'none';

        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –≤ UI
        document.getElementById('micButton').textContent = '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª—é—á–µ–Ω';
        document.getElementById('cameraButton').textContent = '–ö–∞–º–µ—Ä–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞';

        const videoWrapper = document.querySelector('.video-wrapper');
        videoWrapper.addEventListener('click', () => toggleFocus('local'));
        videoWrapper.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            showVolumeSlider(remoteId, e.clientX, e.clientY);
        });
    } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã:", e);
    }
}


async function loadCallChatInfo() {
    try {
        const response = await fetch(`/channels/${channelId}/call-chats/${callChatId}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (!response.ok) {
            throw new Error('Failed to load call chat info');
        }

        const callChat = await response.json();
        document.getElementById('callChatTitle').textContent = callChat.name;
    } catch (error) {
        console.error('Error loading call chat info:', error);
        document.getElementById('callChatTitle').textContent = `–ó–≤–æ–Ω–æ–∫ #${callChatId}`;
    }
}

loadCallChatInfo();

async function createPeerConnection(remoteId) {
    const pc = new RTCPeerConnection({
        iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
    });

    const iceQueue = [];

    pc.onicecandidate = (event) => {
        if (event.candidate) {
            sendSignal(remoteId, { candidate: event.candidate });
        }
    };

    pc.ontrack = (event) => {
        const stream = event.streams[0];

        if (!participants.has(remoteId)) {
            const videoWrapper = document.createElement('div');
            videoWrapper.className = 'video-wrapper';
            videoWrapper.dataset.peerId = remoteId;
            
            // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –Ω–∏–∫–Ω–µ–π–º–∞
            const nicknameLabel = document.createElement('div');
            nicknameLabel.className = 'nickname-label';
            videoWrapper.appendChild(nicknameLabel);

            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞
            videoWrapper.addEventListener('click', () => toggleFocus(remoteId));

            const video = document.createElement('video');
            video.id = `remoteVideo_${remoteId}`;
            video.autoplay = true;
            video.playsInline = true;
            video.srcObject = stream;



            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ü–ö–ú –Ω–∞ —Å–∞–º–æ –≤–∏–¥–µ–æ
videoWrapper.addEventListener('contextmenu', (e) => {
    e.preventDefault();
    showVolumeSlider(remoteId, e.clientX, e.clientY);
});
            const placeholder = document.createElement('div');
            placeholder.className = 'camera-placeholder';
            placeholder.textContent = '–ö–∞–º–µ—Ä–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞';

            videoWrapper.appendChild(video);
            videoWrapper.appendChild(placeholder);
            document.getElementById('videoContainer').appendChild(videoWrapper);

            participants.set(remoteId, video);
            sendSignal(remoteId, {
            requestNickname: true,
            senderId: ownConnectionId
            });

            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–∞–º–µ—Ä—ã/–¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —ç–∫—Ä–∞–Ω–∞, –µ—Å–ª–∏ –±—ã–ª–∏ –æ—Ç–ª–æ–∂–µ–Ω—ã
            if (pendingCameraStates.has(remoteId)) {
                cameraStates.set(remoteId, pendingCameraStates.get(remoteId));
                pendingCameraStates.delete(remoteId);
            }

            if (pendingScreenSharingStates.has(remoteId)) {
                screenSharingStates.set(remoteId, pendingScreenSharingStates.get(remoteId));
                pendingScreenSharingStates.delete(remoteId);
            }

            updateCameraPlaceholder(remoteId);
        } else {
            const video = participants.get(remoteId);
            video.srcObject = stream;
            updateCameraPlaceholder(remoteId);
        }
    };

    pc.oniceconnectionstatechange = () => {
        if (["disconnected", "failed", "closed"].includes(pc.iceConnectionState)) {
            removeParticipant(remoteId);
        }
    };

let streamToSend;

if (isScreenSharing && document.getElementById('localVideo').srcObject) {
    streamToSend = document.getElementById('localVideo').srcObject;
} else {
    streamToSend = localStream;
}

if (streamToSend) {
    for (const track of streamToSend.getTracks()) {
        pc.addTrack(track, streamToSend);
    }
}


    peers.set(remoteId, { pc, iceQueue });

    pc.addEventListener('signalingstatechange', () => {
        const peer = peers.get(remoteId);
        if (peer && pc.remoteDescription && pc.remoteDescription.type) {
            drainIceQueue(peer);
        }
    });

    return pc;
}

async function drainIceQueue(peer) {
    while (peer.iceQueue.length > 0) {
        const candidate = peer.iceQueue.shift();
        try {
            await peer.pc.addIceCandidate(new RTCIceCandidate(candidate));
        } catch (err) {
            console.error("–û—à–∏–±–∫–∞ ICE:", err);
        }
    }
}

function sendSignal(receiverId, signal) {
    signal.senderId = ownConnectionId;
    signal.receiverId = receiverId;
    connection.invoke("SendSignal", JSON.stringify(signal)).catch(console.error);
}

function toggleMic() {
    isMicOn = !isMicOn;
    if (localStream) {
        localStream.getAudioTracks().forEach(track => track.enabled = isMicOn);
    }

    const micButton = document.getElementById('micButton');
    micButton.textContent = isMicOn ? '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª—é—á–µ–Ω' : '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª—é—á–µ–Ω';
}

function toggleCamera() {
    isCameraOn = !isCameraOn;
    if (localStream) {
        localStream.getVideoTracks().forEach(track => track.enabled = isCameraOn);
    }

    document.getElementById('localCameraPlaceholder').style.display = isCameraOn ? 'none' : 'flex';
    document.getElementById('localVideo').style.display = isCameraOn ? 'block' : 'none';

    const cameraButton = document.getElementById('cameraButton');
    cameraButton.textContent = isCameraOn ? '–ö–∞–º–µ—Ä–∞ –≤–∫–ª—é—á–µ–Ω–∞' : '–ö–∞–º–µ—Ä–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞';

    for (const participantId of peers.keys()) {
        sendSignal(participantId, {
            cameraState: isCameraOn,
            senderId: ownConnectionId
        });
    }
}

function updateCameraPlaceholder(connectionId) {
    const videoElement = participants.get(connectionId);
    if (!videoElement) return;

    const wrapper = videoElement.parentElement;
    const placeholder = wrapper.querySelector('.camera-placeholder');
    const cameraState = cameraStates.get(connectionId);

    // –ï—Å–ª–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–∞–º–µ—Ä—ã –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ, —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –∫–∞–º–µ—Ä–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞ (–¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)
    const cameraOn = cameraState === undefined ? false : cameraState;

    if (cameraOn) {
        videoElement.style.display = 'block';
        placeholder.style.display = 'none';
    } else {
        videoElement.style.display = 'none';
        placeholder.style.display = 'flex';
    }
}

function removeParticipant(id) {
    if (participants.has(id)) {
        const video = participants.get(id);
        const wrapper = video.parentElement;
        if (wrapper && wrapper.parentNode) {
            // –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º
            wrapper.removeEventListener('click', () => toggleFocus(id));
            wrapper.parentNode.removeChild(wrapper);
        }
        participants.delete(id);
    }

    if (peers.has(id)) {
        peers.get(id).pc.close();
        peers.delete(id);
    }

    cameraStates.delete(id);
    screenSharingStates.delete(id);
    pendingCameraStates.delete(id);
    pendingScreenSharingStates.delete(id);
}

async function endCall() {
    if (screenStream) stopScreenShare();
    for (const [id, { pc }] of peers.entries()) {
        pc.close();
        peers.delete(id);
    }

    if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
    }

    await connection.invoke("SendSignal", JSON.stringify({
        left: true,
        senderId: ownConnectionId
    }));

    await connection.stop();

    window.location.href = `../ChannelFr/get_channel.html?id=${channelId}`;
}

window.onload = start;

window.addEventListener('beforeunload', async () => {
    if (screenStream) stopScreenShare();
    if (connection && connection.state === signalR.HubConnectionState.Connected) {
        try {
            await connection.invoke("SendSignal", JSON.stringify({ left: true, senderId: ownConnectionId }));
            await connection.stop();
        } catch (err) {
            console.error(err);
        }
    }
    if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
    }
});

async function toggleScreenShare() {
    if (isScreenSharing) {
        stopScreenShare();
    } else {
        await startScreenShare();
    }
}

async function startScreenShare() {
    try {
        screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });

        if (!localStream) {
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
            document.getElementById('localVideo').srcObject = localStream;
        }

        const audioContext = new AudioContext();
        const destination = audioContext.createMediaStreamDestination();

        // –î–æ–±–∞–≤–ª—è–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω
        const micAudioSource = audioContext.createMediaStreamSource(localStream);
        micAudioSource.connect(destination);

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∞—É–¥–∏–æ —É –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —ç–∫—Ä–∞–Ω–∞
        const screenAudioTracks = screenStream.getAudioTracks();
        if (screenAudioTracks.length > 0) {
            const screenAudioSource = audioContext.createMediaStreamSource(new MediaStream([screenAudioTracks[0]]));
            screenAudioSource.connect(destination);
        }

        const combinedStream = new MediaStream();

        // –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–¥–µ–æ —Å —ç–∫—Ä–∞–Ω–∞
        screenStream.getVideoTracks().forEach(track => combinedStream.addTrack(track));

        // –î–æ–±–∞–≤–ª—è–µ–º —Å–º–µ—à–µ–Ω–Ω—ã–π –∞—É–¥–∏–æ —Ç—Ä–µ–∫
        if (destination.stream.getAudioTracks().length > 0) {
            combinedStream.addTrack(destination.stream.getAudioTracks()[0]);
        }

        document.getElementById('localVideo').srcObject = combinedStream;

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç—Ä–µ–∫–∏ –≤ –æ—Ç–ø—Ä–∞–≤–∫–µ peer-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
        for (const [id, { pc }] of peers.entries()) {
            const videoSender = pc.getSenders().find(s => s.track && s.track.kind === 'video');
            if (videoSender) videoSender.replaceTrack(screenStream.getVideoTracks()[0]);

            const audioSender = pc.getSenders().find(s => s.track && s.track.kind === 'audio');
            const newAudioTrack = destination.stream.getAudioTracks()[0];
            if (audioSender && newAudioTrack) audioSender.replaceTrack(newAudioTrack);
        }

        isScreenSharing = true;

        for (const participantId of peers.keys()) {
            sendSignal(participantId, {
                screenSharing: true,
                senderId: ownConnectionId
            });
        }

        document.querySelector('button[onclick="toggleScreenShare()"]').textContent = '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—é';

    } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —ç–∫—Ä–∞–Ω–∞:', err);
    }
}



function stopScreenShare() {
    if (localStream) {
        for (const [id, { pc }] of peers.entries()) {
            const sender = pc.getSenders().find(s => s.track.kind === 'video');
            if (sender) sender.replaceTrack(localStream.getVideoTracks()[0]);
        }
        document.getElementById('localVideo').srcObject = localStream;
    }

    if (screenStream) {
        screenStream.getTracks().forEach(track => track.stop());
        screenStream = null;
    }

    isScreenSharing = false;

    for (const participantId of peers.keys()) {
        sendSignal(participantId, {
            screenSharing: false,
            senderId: ownConnectionId
        });
    }

    document.querySelector('button[onclick="toggleScreenShare()"]').textContent = '–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞';
}

function toggleFocus(peerId) {
    const videoContainer = document.getElementById('videoContainer');
    const allWrappers = document.querySelectorAll('.video-wrapper');
    const clickedWrapper = peerId === 'local'
        ? document.querySelector('.video-wrapper:not([data-peer-id])')
        : document.querySelector(`.video-wrapper[data-peer-id="${peerId}"]`);

    if (!clickedWrapper) return;

    const isAlreadyFocused = clickedWrapper.classList.contains('focused');

    // –°–Ω–∏–º–∞–µ–º —Ñ–æ–∫—É—Å —Å–æ –≤—Å–µ—Ö
    allWrappers.forEach(wrapper => wrapper.classList.remove('focused'));

    if (!isAlreadyFocused) {
        // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–æ–∫—É—Å –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É
        clickedWrapper.classList.add('focused');

        // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –µ–≥–æ –≤ –Ω–∞—á–∞–ª–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
        videoContainer.prepend(clickedWrapper);
    }
    else {
        // –ï—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –Ω–∞ —É–∂–µ —Å—Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ, —Å–Ω–∏–º–∞–µ–º —Ñ–æ–∫—É—Å,
        // –∏ –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫ –∫–∞–∫ –µ—Å—Ç—å –∏–ª–∏ –≤–µ—Ä–Ω—É—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ –≤ –Ω–∞—á–∞–ª–æ
        // –ù–∞–ø—Ä–∏–º–µ—Ä, –≤–µ—Ä–Ω—É—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ –≤ –Ω–∞—á–∞–ª–æ:
        const localWrapper = document.querySelector('.video-wrapper:not([data-peer-id])');
        if (localWrapper) videoContainer.prepend(localWrapper);
    }
}
// –•—Ä–∞–Ω–∏–ª–∏—â–µ –≥—Ä–æ–º–∫–æ—Å—Ç–∏
function showVolumeSlider(peerId, x, y) {
    let existingSlider = document.getElementById(`volumeSlider_${peerId}`);
    if (!existingSlider) {
        existingSlider = document.createElement('div');
        existingSlider.className = 'volume-slider';
        existingSlider.id = `volumeSlider_${peerId}`;

        const range = document.createElement('input');
        range.type = 'range';
        range.min = 0;
        range.max = 1;
        range.step = 0.01;
        range.value = 1; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 100%

        const percentLabel = document.createElement('span');
        percentLabel.textContent = `100%`;

        const toggleBtn = document.createElement('button');
toggleBtn.textContent = 'üîá';
toggleBtn.style.width = '5px';
toggleBtn.style.height = '5px';
toggleBtn.style.display = 'flex';
toggleBtn.style.alignItems = 'center';
toggleBtn.style.justifyContent = 'center';
toggleBtn.style.border = 'none';
toggleBtn.style.background = '#333';
toggleBtn.style.color = '#fff';
toggleBtn.style.cursor = 'pointer';
toggleBtn.style.borderRadius = '6px';
toggleBtn.style.fontSize = '18px';
toggleBtn.style.lineHeight = '1';


        let isMuted = false;
        toggleBtn.addEventListener('click', () => {
            const video = document.getElementById(`remoteVideo_${peerId}`);
            if (!video) return;

            isMuted = !isMuted;
            if (isMuted) {
                video.volume = 0;
                range.value = 0;
                percentLabel.textContent = '0%';
                toggleBtn.textContent = 'üîä';
            } else {
                video.volume = 1;
                range.value = 1;
                percentLabel.textContent = '100%';
                toggleBtn.textContent = 'üîá';
            }
        });

        range.addEventListener('input', () => {
            const vol = parseFloat(range.value);
            const video = document.getElementById(`remoteVideo_${peerId}`);
            if (video) video.volume = vol;

            percentLabel.textContent = `${Math.round(vol * 100)}%`;
            toggleBtn.textContent = vol === 0 ? 'üîä' : 'üîá';
            isMuted = vol === 0;
        });

        existingSlider.appendChild(range);
        existingSlider.appendChild(percentLabel);
        existingSlider.appendChild(toggleBtn);
        document.body.appendChild(existingSlider);
    }

    existingSlider.style.display = 'flex';
    existingSlider.style.left = `${x}px`;
    existingSlider.style.top = `${y}px`;

    const close = (e) => {
        if (!existingSlider.contains(e.target)) {
            existingSlider.style.display = 'none';
            document.removeEventListener('click', close);
        }
    };
    setTimeout(() => document.addEventListener('click', close), 0);
}



async function toggleNoiseSuppression() {
    noiseSuppressionEnabled = !noiseSuppressionEnabled;
    const noiseButton = document.getElementById('noiseButton');
    noiseButton.textContent = noiseSuppressionEnabled
        ? '–®—É–º–æ–ø–æ–¥–∞–≤–ª–µ–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ'
        : '–®—É–º–æ–ø–æ–¥–∞–≤–ª–µ–Ω–∏–µ –≤—ã–∫–ª—é—á–µ–Ω–æ';

    try {
        const newAudioStream = await navigator.mediaDevices.getUserMedia({
            audio: {
                noiseSuppression: noiseSuppressionEnabled,
                echoCancellation: true,
                autoGainControl: true
            }
        });

        const newAudioTrack = await processAudioWithFilters(newAudioStream);
        const oldAudioTrack = localStream.getAudioTracks()[0];

        localStream.removeTrack(oldAudioTrack);
        oldAudioTrack.stop();
        localStream.addTrack(newAudioTrack);

        for (const [id, { pc }] of peers.entries()) {
            const sender = pc.getSenders().find(s => s.track && s.track.kind === 'audio');
            if (sender) sender.replaceTrack(newAudioTrack);
        }
    } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —à—É–º–æ–ø–æ–¥–∞–≤–ª–µ–Ω–∏—è:', err);
    }
}
async function processAudioWithFilters(stream) {
    const audioContext = new AudioContext();
    const source = audioContext.createMediaStreamSource(stream);

    const highpassFilter = audioContext.createBiquadFilter();
    highpassFilter.type = 'highpass';
    highpassFilter.frequency.value = 150; // –û—Ç—Å–µ–∫–∞–µ–º –≤—Å—ë –Ω–∏–∂–µ 150 –ì—Ü

    const compressor = audioContext.createDynamicsCompressor();
    compressor.threshold.setValueAtTime(-50, audioContext.currentTime);
    compressor.knee.setValueAtTime(40, audioContext.currentTime);
    compressor.ratio.setValueAtTime(12, audioContext.currentTime);
    compressor.attack.setValueAtTime(0, audioContext.currentTime);
    compressor.release.setValueAtTime(0.25, audioContext.currentTime);

    const destination = audioContext.createMediaStreamDestination();

    source.connect(highpassFilter);
    highpassFilter.connect(compressor);
    compressor.connect(destination);

    return destination.stream.getAudioTracks()[0];
}



</script>
</body>
</html>
